#!/bin/bash

# $1: file name
# $2: key

defaultPwd=hello
defaultKey=CC5339E4BFFDA4FF3A5395647BE2124E
confPath=${0%\/*}/../etc/tk.conf
tmpKeyPath=${0%\/*}/${0##*\/}.tmp

takeOff() {
	if [ "$1" != "" -a "$2" != "" -a "${1:0:1}" != "-" ] ; then
		fileGeneral=`hexdump -n 8 -e '16/1 "%02X" ' $1`
		fileGeneral=`echo $fileGeneral`
		if [ "$fileGeneral" == "53616C7465645F5F" ] ; then
			dd if="$1" | openssl des3 -d -k "$2" | tar -xf -
		else
			tar -cf - "$1" | openssl des3 -salt -k "$2" | dd of="$1.out"
		fi
	fi
}

getKey() {
	timestamp=`date +%s`
	timestamp=`expr $timestamp / 1000`
	md5Key=`md5 -s $defaultKey$timestamp`
	md5Key=${md5Key##*\ }
	
	if [ -f "$tmpKeyPath" ] ; then
		saveMd5Key=`sed '/^save:/!d;s/save://' $tmpKeyPath`
	fi

	if [ "$saveMd5Key" == "$md5Key" ] ; then
		isOk="true"
	else
		read -s -p ":" tmpPwd
		if [ "$tmpPwd" == "$defaultPwd" ] ; then
            isOk="true"
        fi
	fi

	if [ "$isOk" == "true" ] ; then
		echo "save:"$md5Key > $tmpKeyPath
		echo $defaultKey
	else
		rm -rf $tmpKeyPath
	fi
}

if [ -f "$1" -o -d "$1" ] ; then
	if [ "$2" == "" ] ; then
		key=`getKey`
	else
		key=$2
	fi
	takeOff $1 $key
elif [ "$1" == "-s" ] ; then
	rm -rf $tmpKeyPath
	echo clear temp file.
else
	echo 'tkof: illegal option or file name.'
	echo 'usage:	tkof [filename]'
	echo '	tkof [-t]'
fi
